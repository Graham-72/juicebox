<?php

/**
 * @file
 * Provides Drupal integration with the Juicebox gallery library.
 */


/**
 * Implements hook_menu().
 */
function juicebox_menu() {
  $items = array();
  // Add menu item that produces the "config.xml" data that is linked to a
  // specific view.
  $items['juicebox/xml/%'] = array(
    'title' => 'Juicebox XML from view',
    'description' => '',
    'page callback' => 'juicebox_page_xml',
    'page arguments' => array(2),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  return $items;
}


// Callback for the menu item that generates Juicebox XML linked to a specific
// page. This simply fetches the cached XML that was already created when the
// gallery embed code was rendered.
function juicebox_page_xml() {
  // We don't always know exactly how many args are being passed, so we have to
  // fetch them programmatically with func_get_args()
  $args = func_get_args();
  // Reconstruct the cid that holds the xml related to this request.
  $cid = '';
  foreach ($args as $arg) {
    $cid .= '/' . $arg; 
  }
  $xml = cache_get($cid, 'cache_juicebox');
  // If we did not find a value from the cache take any special actions needed.
  if (!$xml) {
    // Make it clear to Juicebox that we don't have any XML to give it.
    drupal_add_http_header('Status', '404 Not Found');
    // @TODO: Add logic to build the XML if it for some reason it was not in the
    // cache and can actually be built based on the args passed. Under certain
    // caching conditions I suppose it MIGHT be possible for the embed code to
    // be cached in cache_page (meaning the XML is not rebuilt as part of the
    // main gallery page reuest) while the xml is NOT in cache_page OR in
    // cache_juicebox.
  }
  else {
    drupal_add_http_header('Content-Type', 'text/xml');
    print($xml->data);
  }
}


/**
 * Implements hook_views_api().
 */
function juicebox_views_api() {
  return array(
    'api' => 2.0,
  );
}


/**
 * Implements hook_theme().
 */
function juicebox_theme() {
  return array(
    // Theme hook to generate final Juicebox XML
    'juicebox_config_xml' => array(
      'variables' => array('options' => array(), 'images' => array()),
      'path' => drupal_get_path('module', 'juicebox') . '/themes',
      'file' => 'juicebox.theme.inc',
    ),
  );
}


// Generate the config.xml data for a Juicebox gallery from a view object
function juicebox_get_xml_from_view($view) {
  $view_options = $view->style_options; 
  $options = array();
  $options[] = 'galleryTitle="' . $view->human_name .'"';
  $options[] = 'galleryWidth="' . $view->style_options['width'] .'"';
  $options[] = 'galleryHeight="' . $view->style_options['height'] .'"';
  $custom_options = explode("\n", trim($view->style_options['advanced']['config']));
  $options = array_merge($options, $custom_options);
  $images = array();
  foreach ($view->result as $row_index => $row) {
    // Get the main image source
    $field_image_name = "field_{$view_options['image_field']}";
    $field_image_uri = $row->{$field_image_name}[0]['raw']['uri'];
    if (!empty($view_options['image_field_style'])) {
      $image_src = image_style_url($view_options['image_field_style'], $field_image_uri);
    }
    else {
      $image_src = file_create_url($field_image_uri);
    }
    // Get the thumbnail source
    $field_thumb_name = "field_{$view_options['thumb_field']}";
    $field_thumb_uri = $row->{$field_thumb_name}[0]['raw']['uri'];
    if (!empty($view_options['thumb_field_style'])) {
      $thumb_src = image_style_url($view_options['thumb_field_style'], $field_thumb_uri);
    }
    else {
      $thumb_src = file_create_url($field_image_uri);
    }
    // We use $view->render_field in the code below to provide an easy way
    // to get the raw rendered output for each individual non-image field. This
    // gives us a consistent result no matter what the field type is. However, 
    // there may more efficient ways to do this (sans a "render" call). For now
    // while using $view->render_field, note that we have to be sure that the 
    // CURRENT row index is set on the main view object, otherwise rendering 
    // errors may result in certain situations.
    $view->row_index = $row_index;
    $title = $view->render_field($view_options['title_field'], $row_index);
    $caption = $view->render_field($view_options['caption_field'], $row_index);
    // Add each image to the xml
    $images[$row_index]['image_src'] = $image_src;
    $images[$row_index]['thumb_src'] = $thumb_src;
    $images[$row_index]['title'] = $title;
    $images[$row_index]['caption'] = $caption; 
  }
  $data = array('options' => $options, 'images' => $images);
  // Theme the data as juicebox XML
  $xml = theme('juicebox_config_xml', $data);
  return $xml;
}


/**
 * Implements hook_libraries_info().
 */
function juicebox_libraries_info() {
  $libraries['juicebox'] = array(
    'name' => 'Juicebox',
    'vendor url' => 'http://www.juicebox.net/',
    'download url' => 'http://www.juicebox.net/download/',
    'version arguments' => array(
      'file' => 'juicebox.js',
      'pattern' => '/Juicebox-([0-9a-zA-Z\.\ -]+)/',
      'lines' => 5,
    ),
    'files' => array(
      'js' => array('juicebox.js'),
    ),
 );
 return $libraries;
}


/**
 * Implements hook_help().
 */
function juicebox_help($path, $arg) {
  
}

/**
 * Implements hook_flush_caches().
 */
function juicebox_flush_caches() {
  if (db_table_exists('cache_juicebox')) {
    return array('cache_juicebox');
  }
}
